<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Secure DASH + Widevine (Shaka Player)</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/controls.min.css">
  <style>
    body { background:#0f172a; color:#f8fafc; font-family:system-ui; padding:20px; }
    .player { max-width:800px; margin:auto; text-align:center; }
    video { width:100%; border-radius:8px; background:#000; }
    select, button { margin:10px 5px; padding:8px; border-radius:6px; border:1px solid #475569; background:#1e293b; color:#f1f5f9; }
    button { background:#0284c7; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="player">
    <h2>Secure DASH + Widevine</h2>
    <video id="video" class="shaka-video" controls playsinline></video>
    <div>
      <select id="quality"><option value="-1">Auto</option></select>
      <button id="reload">Reload</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const qualitySelect = document.getElementById('quality');
    const reloadBtn = document.getElementById('reload');

    const MANIFEST = '/outputs/manifest.mpd';
    const LICENSE_SERVER = 'http://localhost:8008/widevine'; // Change to your server

    let player, tracks = [];

    async function init() {
      const token = 'Bearer testtoken123'; // In prod: fetch from login API

      if (player) await player.destroy();
      player = new shaka.Player(video);

      // Token for media & license
      const net = player.getNetworkingEngine();
      net.registerRequestFilter((type, req) => {
        req.headers['Authorization'] = token;
      });

      // DRM (use clearKeys for testing, replace with real server in prod)
      player.configure({
        drm: {
          servers: { 'com.widevine.alpha': LICENSE_SERVER },
          clearKeys: {
            'MTIzNDU2Nzg5MGFiY2RlZjEyMzQ1Njc4OTBhYmNkZWY=': // key_id (hex → base64)
            'YWJjZGVmYWJjZGVmYWJjZGVmYWJjZGVmYWJjZGVmYWJj'  // key (hex → base64)
          }
        }
      });

      // UI
      new shaka.ui.Overlay(player, video.parentElement, video);

      try {
        await player.load(MANIFEST);
        populateQuality();
        video.play();
      } catch (e) {
        console.error('Load error:', e);
      }
    }

    function populateQuality() {
      tracks = player.getVariantTracks();
      const heights = [...new Set(tracks.map(t => t.height))].sort((a,b)=>b-a);
      qualitySelect.innerHTML = '<option value="-1">Auto</option>';
      heights.forEach(h => {
        const opt = new Option(`${h}p`, h);
        qualitySelect.appendChild(opt);
      });
    }

    qualitySelect.onchange = () => {
      const h = parseInt(qualitySelect.value);
      if (h === -1) {
        player.configure('abr.enabled', true);
      } else {
        player.configure('abr.enabled', false);
        const track = tracks.find(t => t.height === h);
        if (track) player.selectVariantTrack(track, true);
      }
    };

    reloadBtn.onclick = init;
    init();
  </script>
</body>
</html>
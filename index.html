<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Universal Player (HLS + DASH + DRM)</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.10/shaka-player.compiled.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #0f172a;
      color: #f8fafc;
      font-family: system-ui, sans-serif;
      padding: 30px;
    }
    video {
      width: 80%;
      max-width: 900px;
      border-radius: 12px;
      box-shadow: 0 0 20px #0008;
      margin-top: 20px;
    }
    select, input, button {
      padding: 8px 12px;
      background: #1e293b;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      margin: 6px;
    }
    option { background: #1e293b; }
  </style>
</head>
<body>
  <h2>Universal Media Player (HLS / DASH / DRM)</h2>

  <input type="text" id="sourceUrl" value="/outputs/manifest.mpd" placeholder="Enter .mpd or .m3u8 URL" size="50" />
  <button id="loadBtn">Load</button><br>

  <video id="video" controls autoplay></video><br>

  <label for="quality">Resolution: </label>
  <select id="quality"><option value="">Auto</option></select>

  <script>
    const video = document.getElementById('video');
    const qualitySelect = document.getElementById('quality');
    const sourceInput = document.getElementById('sourceUrl');
    const loadBtn = document.getElementById('loadBtn');
    let hls = null, shakaPlayer = null;

    // DASH ClearKey DRM example
    const KEY_ID = '740b297392b58353acca01f5302b59f9';
    const KEY = 'a0ef87b5ba153e3d22c2e204710235a4';

    loadBtn.addEventListener('click', () => {
      const url = sourceInput.value.trim();
      if (!url) return alert('Please enter a URL.');
      loadSource(url);
    });

    async function loadSource(url) {
      cleanupPlayers();
      if (url.endsWith('.mpd')) {
        await initShaka(url);
      } else if (url.endsWith('.m3u8')) {
        await initHls(url);
      } else {
        alert('Unsupported file. Use .mpd or .m3u8');
      }
    }

    function cleanupPlayers() {
      if (hls) { hls.destroy(); hls = null; }
      if (shakaPlayer) { shakaPlayer.destroy(); shakaPlayer = null; }
      qualitySelect.innerHTML = '<option value="">Auto</option>';
      video.removeAttribute('src');
      video.load();
    }

    // ---------- DASH ----------
    async function initShaka(manifestUri) {
      shakaPlayer = new shaka.Player(video);
      window.player = shakaPlayer;

      shakaPlayer.configure({
        drm: { clearKeys: { [KEY_ID]: KEY } },
        abr: { enabled: true }
      });

      await shakaPlayer.load(manifestUri);
      console.log('Shaka: Video loaded.');

      populateShakaQualities();

      qualitySelect.addEventListener('change', () => {
        const selectedId = qualitySelect.value;
        if (!selectedId) {
          shakaPlayer.configure({ abr: { enabled: true } });
          console.log('Switched to Auto');
          return;
        }
        const track = shakaPlayer.getVariantTracks().find(t => t.id == selectedId);
        if (track) {
          shakaPlayer.configure({ abr: { enabled: false } });
          shakaPlayer.selectVariantTrack(track, true);
          console.log(`Switched to ${track.height}p`);
        }
      });
    }

    function populateShakaQualities() {
      const tracks = shakaPlayer.getVariantTracks().filter(t => t.videoBandwidth);
      const sorted = [...tracks].sort((a, b) => a.height - b.height);

      qualitySelect.innerHTML = '<option value="">Auto</option>';
      for (const t of sorted) {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = `${t.height || '?'}p (${Math.round(t.bandwidth / 1000)} kbps)`;
        qualitySelect.appendChild(opt);
      }

      const active = sorted.find(t => t.active);
      if (active) qualitySelect.value = active.id;
    }

    // ---------- HLS ----------
    async function initHls(sourceUrl) {
      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(sourceUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          const levels = data.levels || [];
          populateHlsQualities(levels);

          // Reflect current level in the dropdown
          if (hls.currentLevel >= 0) qualitySelect.value = hls.currentLevel;

          video.play().catch(e => console.warn("Play interrupted:", e));
        });

        // Debug: show what is really playing
        hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
          const level = hls.levels[data.level];
          console.log('HLS playing:', {
            height: level.height,
            width: level.width,
            bitrate: level.bitrate,
            codecs: level.codecs
          });
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = sourceUrl;
        video.addEventListener('loadedmetadata', () => video.play());
      } else {
        alert('HLS not supported by this browser.');
      }
    }

    // ----- FIXED QUALITY POPULATION -----
    function populateHlsQualities(levels) {
      qualitySelect.innerHTML = '<option value="">Auto</option>';

      const sorted = [...levels].sort((a, b) => {
        const ha = a.height || 0;
        const hb = b.height || 0;
        if (ha && hb) return ha - hb;
        if (ha) return -1;
        if (hb) return 1;
        return a.bitrate - b.bitrate;
      });

      sorted.forEach((level, index) => {
        // 1. Try level.height
        let height = level.height;

        // 2. If missing, try the RESOLUTION attribute in level.attrs
        if (!height && level.attrs && level.attrs.RESOLUTION) {
          const res = level.attrs.RESOLUTION.split('x');
          height = parseInt(res[1], 10) || null;   // take the vertical part
        }

        // 3. Last-resort bitrate estimate (very rare)
        if (!height) {
          const bw = level.bitrate;
          if (bw < 500_000) height = 240;
          else if (bw < 1_000_000) height = 360;
          else if (bw < 2_000_000) height = 480;
          else if (bw < 4_000_000) height = 720;
          else height = 1080;
        }

        const bitrateKbps = Math.round(level.bitrate / 1000);
        const label = height ? `${height}p` : 'Unknown';

        const opt = document.createElement('option');
        opt.value = index;                     // zero-based
        opt.textContent = `${label} (${bitrateKbps} kbps)`;
        qualitySelect.appendChild(opt);
      });

      qualitySelect.onchange = () => {
        const value = Number(qualitySelect.value);
        if (isNaN(value)) {
          hls.currentLevel = -1;               // Auto
          console.log('HLS: Switched to Auto');
        } else {
          hls.currentLevel = value;
          const selected = sorted[value];
          const h = selected.height ||
                    (selected.attrs && selected.attrs.RESOLUTION && selected.attrs.RESOLUTION.split('x')[1]) ||
                    'Unknown';
          console.log(`HLS: Switched to ${h}p (${Math.round(selected.bitrate/1000)} kbps)`);
        }
      };
    }

    // auto-load on start
    document.addEventListener('DOMContentLoaded', () => {
      loadSource(sourceInput.value);
    });
  </script>
</body>
</html>